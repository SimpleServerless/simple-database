AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: "Simple serverless database configuration"

Parameters:
  StageName:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
      - local
      - stage
    Description: The environment to be run on (typically local, dev, stage or prod)

  VpcId:
    Type: AWS::SSM::Parameter::Value<String>
    Default: VpcId


Mappings:
  Environment:
    dev:
      "DBClusterIdentifier": "simple-serverless-aurora-serverless-development"
      "DBName": "simple_serverless_dev"
      "DBSubnetGroupName": "private" # WARNING: these are public subnets don't do this for data that needs to be secure.
      "BackupRetentionPeriod": 1
      "DBInstancePrimaryIdentifier": "simple-severless-primary-development"
      "DBInstanceReplicaIdentifier": "simple-severless-replica-development"

Conditions:
  IsProdCondition:
    !Equals [!Ref StageName, prod]

Resources:

  # Create a security group to be used by anything accessing this DB
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SimpleServerlessSG
      VpcId: !Ref VpcId
      GroupDescription: Simple service lambda security group

  # Create the security group to be used by this DB
  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SimpleServerlessDBSG
      VpcId: !Ref VpcId
      GroupDescription: Simple service db security group
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 65535
          CidrIp: 0.0.0.0/0
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !GetAtt AppSecurityGroup.GroupId
    DependsOn: AppSecurityGroup

  SimpleServerlessCluster:
    Type: AWS::RDS::DBCluster
    # If this entire CloudFormation stack is deleted make a snapshot first.
    DeletionPolicy: Snapshot
    Properties:
      DBClusterIdentifier: { "Fn::FindInMap": [ "Environment", { "Ref": "StageName" }, "DBClusterIdentifier" ] }
      Engine: aurora-postgresql
      EngineMode: provisioned
      EngineVersion: '11.9'
      StorageEncrypted: true
      DatabaseName: { "Fn::FindInMap": [ "Environment", { "Ref": "StageName" }, "DBName" ] }
      # IMPORTANT: If copying this template don't re-user these secretmanager values for your project
      MasterUsername: '{{resolve:secretsmanager:simple-serverless/db-credentials:SecretString:username}}'
      MasterUserPassword: '{{resolve:secretsmanager:simple-serverless/db-credentials:SecretString:password}}'
      BackupRetentionPeriod: { "Fn::FindInMap": [ "Environment", { "Ref": "StageName" }, "BackupRetentionPeriod" ] }
      DeletionProtection: false
      DBClusterParameterGroupName: "aurora-postgresql11"
      DBSubnetGroupName: { "Fn::FindInMap": [ "Environment", { "Ref": "StageName" }, "DBSubnetGroupName" ] }
      VpcSecurityGroupIds:
        - !Ref DBSecurityGroup

  SimpleServerlessClusterPrimaryInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: { "Fn::FindInMap": [ "Environment", { "Ref": "StageName" }, "DBInstancePrimaryIdentifier" ] }
      Engine: aurora-postgresql
      AllowMajorVersionUpgrade: true
      AutoMinorVersionUpgrade: true
      DBClusterIdentifier: !Ref SimpleServerlessCluster
      DBInstanceClass: db.t3.medium
      DBSubnetGroupName: { "Fn::FindInMap": [ "Environment", { "Ref": "StageName" }, "DBSubnetGroupName" ] }
      PubliclyAccessible: false

  SimpleServerlessClusterReplicaInstance:
    Type: AWS::RDS::DBInstance
    Condition: IsProdStageCondition
    Properties:
      DBInstanceIdentifier: { "Fn::FindInMap": [ "Environments", { "Ref": "StageName" }, "DBInstanceReplicaIdentifier" ] }
      Engine: aurora-postgresql
      AllowMajorVersionUpgrade: 'true'
      AutoMinorVersionUpgrade: 'true'
      DBClusterIdentifier: !Ref SimpleServerlessCluster
      DBInstanceClass: db.t3.medium
      DBSubnetGroupName: { "Fn::FindInMap": [ "Environments", { "Ref": "StageName" }, "DBSubnetGroupName" ] }
      PubliclyAccessible: false


Outputs:
  SimpleSSHost:
    Value: !GetAtt SimpleServerlessCluster.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-Host'
  SimpleSSName:
    Value: {"Fn::FindInMap": [ "Environment", { "Ref": "StageName" }, "DBName"]}
    Export:
      Name: !Sub '${AWS::StackName}-Name'
  SimpleSSAppSecurityGroupId:
    Value: !GetAtt AppSecurityGroup.GroupId
    Export:
      Name: !Sub '${AWS::StackName}-AppSGId'
